{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'listing_service/css/listings.css' %}" />
{% endblock %}

{% block head_title %}
  HoosHousing? - Property Listings
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h1 class="mb-4">Properties</h1>

    {% if request.user.role == 'librarian' %}
      <a class="btn btn-quaternary mb-4 me-2"
         href="{% url 'listing_service:add_property' %}">
        <i class="fa-solid fa-plus me-1"></i> Add New Property
      </a>
      <button id="editPropertiesBtn" class="btn btn-secondary mb-4">
        <i class="fas fa-edit me-1"></i> Edit Properties
      </button>
    {% endif %}

    <form method="GET"
          action="{% url 'listing_service:property_listing' %}"
          class="row g-2 align-items-center mb-4">
      <!-- search input -->
      <div class="col-12 col-md" style="min-width: 0;">
        <input type="text"
               name="q"
               class="form-control shadow-sm"
               placeholder="Searchâ€¦"
               value="{{ query }}">
      </div>

      <!-- all buttons in one group, centered vertically -->
      <div class="col-12 col-md-auto d-flex align-items-center gap-2">
        <!-- Filter dropdown -->
        <div class="dropdown" data-bs-auto-close="false">
          <button class="btn btn-outline-secondary dropdown-toggle"
                  type="button"
                  id="tagsDropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            <i class="fa-solid fa-filter me-1"></i> Filter
          </button>
          <div class="dropdown-menu p-3 dropdown-menu-columns shadow property-filter-menu"
               aria-labelledby="tagsDropdown"
               style="max-height: 500px; overflow-y: auto; column-gap:30px;">
            <!-- Type -->
            <div class="column">
              <strong>Type</strong>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       name="types"
                       id="type-all"
                       value="all"
                       {% if not selected_types or 'all' in selected_types %}checked{% endif %}>
                <label class="form-check-label" for="type-all">All Types</label>
              </div>
              {% for code,label in type_choices %}
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="types"
                         id="type-{{ forloop.counter }}"
                         value="{{ code }}"
                         {% if code in selected_types %}checked{% endif %}>
                  <label class="form-check-label"
                         for="type-{{ forloop.counter }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
            <!-- Region -->
            <div class="column">
              <strong>Region</strong>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       name="regions"
                       id="region-all"
                       value="all"
                       {% if not selected_regions or 'all' in selected_regions %}checked{% endif %}>
                <label class="form-check-label" for="region-all">
                  All Locations
                </label>
              </div>
              {% for code,label in region_choices %}
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="regions"
                         id="region-{{ forloop.counter }}"
                         value="{{ code }}"
                         {% if code in selected_regions %}checked{% endif %}>
                  <label class="form-check-label"
                         for="region-{{ forloop.counter }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
            <!-- Proximity -->
            <div class="column">
              <strong>Proximity</strong>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       name="proximities"
                       id="prox-all"
                       value="all"
                       {% if not selected_proximities or 'all' in selected_proximities %}checked{% endif %}>
                <label class="form-check-label" for="prox-all">
                  All Proximities
                </label>
              </div>
              {% for code,label in proximity_choices %}
                <div class="form-check">
                  <input class="form-check-input"
                         type="checkbox"
                         name="proximities"
                         id="prox-{{ forloop.counter }}"
                         value="{{ code }}"
                         {% if code in selected_proximities %}checked{% endif %}>
                  <label class="form-check-label"
                         for="prox-{{ forloop.counter }}">{{ label }}</label>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Search button -->
        <button class="btn btn-primary" type="submit">
          <i class="fas fa-search me-1"></i> Search
        </button>

        <div class="dropdown property-sort-dropdown" id="sortDropdownContainer">
          <button class="btn btn-outline-secondary dropdown-toggle"
                 type="button"
                 id="sortDropdown"
                 data-bs-toggle="dropdown">
                 <i class="fa-solid fa-arrow-up-wide-short me-1"></i> Sort
          </button>
          <ul class="dropdown-menu property-sort-menu" aria-labelledby="sortDropdown">
            {% for key,label,arrow in sort_options %}
              <li>
                <button
                  class="dropdown-item {% if sort == key %}active{% endif %}"
                  type="submit"
                  name="sort"
                  value="{{ key }}">
                  {{ label }} {{ arrow }}
                </button>
              </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Clear link -->
        <a href="{% url 'listing_service:property_listing' %}"
           class="btn btn-quaternary">
          Clear
        </a>
      </div>
    </form>

    <div class="row" id="propertiesContainer">
      {% for property in properties %}
        <div class="col-md-4 col-lg-3 mb-3">
          <div class="property-card {% if property.status == 'leased' %}leased{% endif %}">
            <div class="edit-icons" style="display: none;">
              <a href="{% url 'listing_service:edit_property' property.id %}"
                 class="edit-icon">
                <i class="fas fa-edit"></i>
              </a>
              <form method="POST"
                    action="{% url 'listing_service:delete_property' property.id %}"
                    class="d-inline delete-form">
                {% csrf_token %}
                <button type="submit"
                        class="btn-link delete-icon"
                        onclick="return confirm('Are you sure you want to delete this property?');">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </form>
            </div>

            <a href="{% url 'listing_service:property_details' property.id %}"
               class="text-decoration-none text-dark">
              <div class="image-container">
                {% if property.image %}
                  <img src="{{ property.image }}"
                       alt="{{ property.title }}"
                       class="property-img"
                       onerror="this.onerror=null;
                                this.src='{% static 'mysite/assets/property-placeholder.png' %}';">
                {% else %}
                  <img src="{% static 'mysite/assets/property-placeholder.png' %}"
                       alt="Default Property Image"
                       class="property-img">
                {% endif %}
              </div>
              <div class="property-info">
                <h2 class="property-title">{{ property.title }}</h2>
                <p class="property-location">{{ property.location }}</p>
                <div class="property-rating">
                  {% for i in '12345' %}
                    {% if property.average_rating|floatformat == i|stringformat:'s' %}
                      <i class="fas fa-star"></i>
                    {% elif property.average_rating|floatformat > i|stringformat:'s' %}
                      <i class="fas fa-star"></i>
                    {% elif property.average_rating|floatformat > i|add:'-0.5'|stringformat:'s' %}
                      <i class="fas fa-star-half-alt"></i>
                    {% else %}
                      <i class="far fa-star"></i>
                    {% endif %}
                  {% endfor %}
                  <small class="text-muted">{{ property.average_rating }}</small>
                  <small class="text-muted">({{ property.review_count }})</small>
                </div>
                <p class="property-price mb-1">${{ property.price }} month</p>
                <p class="property-description mt-1">
                  {{ property.description|truncatechars:45 }}
                </p>
                <div class="property-tags">
                  {% if property.property_type %}
                    <span class="badge bg-primary fs-100">
                      {{ property.property_type }}
                    </span>
                  {% endif %}
                  {% if property.region %}
                    <span class="badge bg-success">
                      {{ property.get_region_display }}
                    </span>
                  {% endif %}
                  {% if property.proximity %}
                    <span class="badge bg-warning">
                      {{ property.get_proximity_display }}
                    </span>
                  {% endif %}
                </div>
              </div>
            </a>
          </div>
        </div>
      {% empty %}
        <div class="col-12">
          <div class="alert alert-info">No properties available.</div>
        </div>
      {% endfor %}
    </div>

    {% block extra_js %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const editBtn = document.getElementById('editPropertiesBtn');
        const editIcons = document.querySelectorAll('.edit-icons');
        const propertiesContainer = document.getElementById('propertiesContainer');
        let editMode = false;
        
        const urlParams = new URLSearchParams(window.location.search);
        const shouldEnableEditMode = urlParams.get('edit_mode') === 'true';
        
        function toggleEditMode(enable) {
          editMode = enable;
          editIcons.forEach(icon => {
            icon.style.display = editMode ? 'block' : 'none';
          });
          
          if (editMode) {
            propertiesContainer.classList.add('edit-mode');
            editBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 3px;"></i> Finish Editing';
            editBtn.classList.remove('btn-secondary');
            editBtn.classList.add('btn-success');
          } else {
            propertiesContainer.classList.remove('edit-mode');
            editBtn.innerHTML = '<i class="fas fa-edit" style="margin-right: 3px;"></i> Edit Properties';
            editBtn.classList.remove('btn-success');
            editBtn.classList.add('btn-secondary');
          }            
        }
        
        if (shouldEnableEditMode) {
          toggleEditMode(true);
          
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
        }
        
        editBtn.addEventListener('click', function() {
          toggleEditMode(!editMode);
        });
      });
  
      document.addEventListener('DOMContentLoaded', function() {
        const tagsDropdown = document.getElementById('tagsDropdown');
        const filterButton = document.querySelector('button[type="submit"]');
        const dropdown = new bootstrap.Dropdown(tagsDropdown);
        
        filterButton.addEventListener('click', function() {
          dropdown.hide();
        });
      });       
      
      document.addEventListener('DOMContentLoaded', function() {
        const labels = document.querySelectorAll('.dropdown-menu label');
        
        labels.forEach(label => {
          label.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        });
      });       
      
      document.addEventListener('DOMContentLoaded', function() {
        const reverseCheckbox = document.querySelector('#sortDropdown + .dropdown-menu .form-check-input');
        if (reverseCheckbox) {
          reverseCheckbox.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        }
      });

        document.addEventListener('DOMContentLoaded', () => {

          ['types','regions','proximities'].forEach(groupName => {

            const boxes = document.querySelectorAll(`input[name="${groupName}"]`);
            boxes.forEach(box => {
              box.addEventListener('change', () => {
                if (box.checked) {

                  boxes.forEach(other => {
                    if (other !== box) other.checked = false;
                  });
                }
              });
            });
          });
        });
  </script>
    {% endblock %}
  </div>
{% endblock %}
